name: License Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write  # For commenting on PRs

jobs:
  check-licenses:
    name: Check Dependency Licenses
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Download dependencies
        run: go mod download

      - name: Check for restricted licenses
        run: |
          echo "Checking for restricted licenses..."

          # List of prohibited licenses (case-insensitive patterns)
          RESTRICTED_LICENSES=(
            "AGPL"
            "GPL-2.0"
            "GPL-3.0"
            "LGPL-2.0"
            "LGPL-2.1"
            "LGPL-3.0"
            "SSPL"
            "Commons-Clause"
            "BUSL"
          )

          # Get all licenses from dependencies
          echo "Scanning all dependencies for licenses..."
          go-licenses report ./... 2>&1 | tee licenses.txt || true

          # Check for restricted licenses
          FOUND_RESTRICTED=false
          for license in "${RESTRICTED_LICENSES[@]}"; do
            if grep -i "$license" licenses.txt; then
              echo "❌ ERROR: Found restricted license: $license"
              FOUND_RESTRICTED=true
            fi
          done

          if [ "$FOUND_RESTRICTED" = true ]; then
            echo ""
            echo "=========================================="
            echo "❌ RESTRICTED LICENSES DETECTED"
            echo "=========================================="
            echo "The following restricted licenses were found in dependencies:"
            echo ""
            cat licenses.txt | grep -iE "$(IFS="|"; echo "${RESTRICTED_LICENSES[*]}")" || true
            echo ""
            echo "Please remove dependencies with these licenses or seek legal approval."
            exit 1
          fi

          echo ""
          echo "✅ No restricted licenses found!"

      - name: Comment on PR (if violations found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let licenses = '';
            try {
              licenses = fs.readFileSync('licenses.txt', 'utf8');
            } catch (e) {
              console.log('Could not read licenses.txt');
              return;
            }

            const restrictedLicenses = ['AGPL', 'GPL-2.0', 'GPL-3.0', 'LGPL-2.0', 'LGPL-2.1', 'LGPL-3.0', 'SSPL', 'Commons-Clause', 'BUSL'];

            let violations = '';
            for (const license of restrictedLicenses) {
              const regex = new RegExp(license, 'i');
              const matches = licenses.split('\n').filter(line => regex.test(line));
              if (matches.length > 0) {
                violations += matches.join('\n') + '\n';
              }
            }

            if (!violations) {
              return;
            }

            const body = `## ❌ License Check Failed

            This PR cannot be merged because restricted licenses were detected in dependencies.

            ### Restricted Licenses Found:
            \`\`\`
            ${violations}
            \`\`\`

            ### Blocked License Types:
            - AGPL (all versions)
            - GPL-2.0, GPL-3.0
            - LGPL-2.0, LGPL-2.1, LGPL-3.0
            - SSPL (Server Side Public License)
            - Commons Clause
            - BUSL (Business Source License)

            **Action Required:** Please remove or replace the dependencies with restricted licenses before this PR can be merged.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Generate license report
        if: success()
        run: |
          echo "Generating detailed license report..."
          echo "# License Report" > license-report.md
          echo "" >> license-report.md
          echo "Generated on: $(date)" >> license-report.md
          echo "" >> license-report.md
          echo "## All Dependency Licenses" >> license-report.md
          echo "" >> license-report.md
          echo '```' >> license-report.md
          cat licenses.txt >> license-report.md
          echo '```' >> license-report.md

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.txt
            license-report.md
          retention-days: 30
